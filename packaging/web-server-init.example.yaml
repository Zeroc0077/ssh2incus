#cloud-config
# ssh2incus Web Server Setup Example
# This demonstrates ssh2incus dynamic instance creation with cloud-init
# Features: Instant nginx deployment with custom website configuration

# DO NOT EDIT THIS FILE. IT WILL BE OVERWRITTEN EVERY TIME YOU UPDATE ssh2incus
# CLONE THIS FILE INSTEAD OF EDITING IT

package_update: true
package_upgrade: true

packages:
    - nginx
    - curl
    - ufw

write_files:
    # Main index.html page
    - path: /var/www/demo/index.html
      content: |
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Demo Web Server</title>
              <link rel="stylesheet" href="/styles.css">
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>🚀 Welcome to Your ssh2incus Web Server!</h1>
                      <p class="subtitle">Powered by ssh2incus Dynamic Instance Creation + nginx</p>
                  </header>
                  <main>
                      <section class="info-box">
                          <h2>Server Information</h2>
                          <p>This web server was instantly deployed using <strong>ssh2incus</strong> dynamic instance creation!</p>
                          <p>With ssh2incus, you can create fully-configured LXD/Incus containers on-demand via SSH.</p>
                          <p>Hostname: <strong id="hostname"></strong></p>
                          <p>Server Time: <strong id="servertime"></strong></p>
                      </section>
                      <section class="features">
                          <h2>ssh2incus Features Demonstrated</h2>
                          <ul>
                              <li>✓ Dynamic instance creation via SSH connection</li>
                              <li>✓ Cloud-init integration for automated setup</li>
                              <li>✓ nginx web server installed and running</li>
                              <li>✓ Custom website deployed automatically</li>
                              <li>✓ Firewall configured (ports 80, 443)</li>
                              <li>✓ Zero-touch deployment - ready in seconds!</li>
                              <li>✓ Sample API endpoint available</li>
                          </ul>
                      </section>
                      <section class="api-test">
                          <h2>Try It Out</h2>
                          <p>Test the API endpoint created by ssh2incus:</p>
                          <code>curl http://your-server-ip/api/status</code>
                          <p style="margin-top: 15px;">Learn more: <a href="https://github.com/yourusername/ssh2incus" style="color: #90cdf4;">github.com/ssh2incus</a></p>
                      </section>
                  </main>
                  <footer>
                      <p>⚡ Instantly deployed with ssh2incus | Automated with cloud-init | Powered by nginx</p>
                  </footer>
              </div>
              <script src="/script.js"></script>
          </body>
          </html>
      permissions: "0644"
      owner: www-data:www-data

    # CSS Stylesheet
    - path: /var/www/demo/styles.css
      content: |
          * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
          }
          body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              min-height: 100vh;
              padding: 20px;
              color: #333;
          }
          .container {
              max-width: 900px;
              margin: 0 auto;
              background: white;
              border-radius: 10px;
              box-shadow: 0 20px 60px rgba(0,0,0,0.3);
              overflow: hidden;
          }
          header {
              background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
              color: white;
              padding: 40px;
              text-align: center;
          }
          header h1 {
              font-size: 2.5em;
              margin-bottom: 10px;
          }
          .subtitle {
              font-size: 1.2em;
              opacity: 0.9;
          }
          main {
              padding: 40px;
          }
          section {
              margin-bottom: 30px;
          }
          h2 {
              color: #5a67d8;
              margin-bottom: 15px;
              font-size: 1.8em;
          }
          .info-box {
              background: #f7fafc;
              padding: 20px;
              border-radius: 8px;
              border-left: 4px solid #5a67d8;
          }
          .info-box p {
              margin: 10px 0;
              font-size: 1.1em;
          }
          .features ul {
              list-style: none;
              padding-left: 0;
          }
          .features li {
              padding: 10px;
              margin: 8px 0;
              background: #edf2f7;
              border-radius: 5px;
              font-size: 1.1em;
          }
          .api-test {
              background: #2d3748;
              color: white;
              padding: 20px;
              border-radius: 8px;
          }
          .api-test h2 {
              color: #90cdf4;
          }
          .api-test code {
              display: block;
              background: #1a202c;
              padding: 15px;
              border-radius: 5px;
              margin-top: 10px;
              font-family: 'Courier New', monospace;
              color: #48bb78;
          }
          footer {
              background: #2d3748;
              color: white;
              text-align: center;
              padding: 20px;
          }
      permissions: "0644"
      owner: www-data:www-data

    # JavaScript for dynamic content
    - path: /var/www/demo/script.js
      content: |
          document.addEventListener('DOMContentLoaded', function() {
              // Display hostname
              fetch('/api/status')
                  .then(response => response.json())
                  .then(data => {
                      document.getElementById('hostname').textContent = data.hostname;
                  })
                  .catch(err => {
                      document.getElementById('hostname').textContent = window.location.hostname;
                  });

              // Display server time
              function updateTime() {
                  const now = new Date();
                  document.getElementById('servertime').textContent = now.toLocaleString();
              }
              updateTime();
              setInterval(updateTime, 1000);
          });
      permissions: "0644"
      owner: www-data:www-data

    # API endpoint simulation using static JSON
    - path: /var/www/demo/api/status
      content: |
          {
              "status": "running",
              "hostname": "demo-server",
              "service": "nginx",
              "deployed_by": "ssh2incus",
              "deployment_method": "dynamic instance creation",
              "version": "1.0",
              "message": "Web server deployed instantly with ssh2incus!"
          }
      permissions: "0644"
      owner: www-data:www-data

    # nginx site configuration
    - path: /etc/nginx/sites-available/demo
      content: |
          server {
              listen 80 default_server;
              listen [::]:80 default_server;

              root /var/www/demo;
              index index.html;

              server_name _;

              location / {
                  try_files $uri $uri/ =404;
              }

              location /api/status {
                  default_type application/json;
                  add_header Content-Type application/json;
              }

              # Enable gzip compression
              gzip on;
              gzip_vary on;
              gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

              # Security headers
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header X-XSS-Protection "1; mode=block" always;

              # Cache static assets
              location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
                  expires 7d;
                  add_header Cache-Control "public, immutable";
              }
          }
      permissions: "0644"

runcmd:
    # Create necessary directories
    - mkdir -p /var/www/demo/api

    # Set proper ownership
    - chown -R www-data:www-data /var/www/demo

    # Disable default nginx site
    - rm -f /etc/nginx/sites-enabled/default

    # Enable our demo site
    - ln -sf /etc/nginx/sites-available/demo /etc/nginx/sites-enabled/demo

    # Test nginx configuration
    - nginx -t

    # Enable nginx to start on boot
    - systemctl enable nginx

    # Configure firewall (UFW)
    - ufw --force enable
    - ufw allow 80/tcp
    - ufw allow 443/tcp

    # Create completion marker
    - echo "ssh2incus web server setup completed at $(date)" > /tmp/cloud-init-webserver-done
    - echo "Deployed via ssh2incus dynamic instance creation" >> /tmp/cloud-init-webserver-done

    # Restart nginx
    - systemctl restart nginx

    # Log nginx status
    - systemctl status nginx > /tmp/nginx-status.log


final_message: |
    ========================================
    🚀 ssh2incus Web Server Deployment Complete!
    ========================================

    Your nginx web server is now running!
    This instance was created dynamically using ssh2incus.

    🌐 Access your website at:
       http://YOUR_SERVER_IP/

    🔌 Test the API endpoint:
       curl http://YOUR_SERVER_IP/api/status

    📊 Check nginx status:
       systemctl status nginx

    📝 View logs:
       - nginx access: /var/log/nginx/access.log
       - nginx error: /var/log/nginx/error.log
       - cloud-init: /var/log/cloud-init-output.log

    ⚡ ssh2incus Features Used:
       - Dynamic instance creation via SSH
       - Automated cloud-init configuration
       - Zero-touch web server deployment
       - Ready in seconds!

    Learn more about ssh2incus and create your own
    dynamic instances with custom configurations!

    ========================================
